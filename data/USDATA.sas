/*FINAL PROJECT - DATA CLEANING*/ 

/*IMPORTING IN GS16 FILE - HAS 2016 AND 2015 FIGURES*/ 
PROC IMPORT DATAFILE = 'H:\3.Teams and Projects\gradproject\GS16.XLSX'
OUT=GS16
DBMS=XLSX
REPLACE;
RUN;

/*PULLING ONLY THE VARIABLES WE NEED*/ 
PROC SQL NOPRINT; 

CREATE TABLE GS16_2 AS
SELECT	IFC(NAICS_ID EQ '31-33','31',NAICS_ID) AS NAICS LABEL="",
		NAICS_DISPLAY_LABEL AS NAICS_DESC LABEL="",
		GEO_DISPLAY_LABEL AS COUNTRY LABEL="",
		YEAR_ID AS YEAR LABEL="",
		RCPTOT, 
		CSTMTOT,
		PAYANN,
		EMP,
		/*STUFF YOU DON'T THINK YOU'LL NEED BUT ARE PULLING JUST IN CASE*/ 
		EMPAVPW,
		PAYANPW,
		BENEFIT
FROM GS16
ORDER BY CALCULATED NAICS, YEAR; 

QUIT; 

/*2014 DATA*/ 

/*IMPORTING IN GS14 FILE - HAS 2014 FIGURES*/ 
PROC IMPORT DATAFILE = 'H:\3.Teams and Projects\gradproject\GS14.XLSX'
OUT=GS14
DBMS=XLSX
REPLACE;
RUN;

/*PULLING ONLY THE VARIABLES WE NEED*/ 
PROC SQL NOPRINT; 

CREATE TABLE GS14_2 AS
SELECT	IFC(NAICS_ID EQ '31-33','31',NAICS_ID) AS NAICS LABEL="",
		NAICS_DISPLAY_LABEL AS NAICS_DESC LABEL="",
		GEO_DISPLAY_LABEL AS COUNTRY LABEL="",
		YEAR_ID AS YEAR LABEL="",
		RCPTOT, 
		CSTMTOT,
		PAYANN,
		EMP,
		/*STUFF YOU DON'T THINK YOU'LL NEED BUT ARE PULLING JUST IN CASE*/ 
		EMPAVPW,
		PAYANPW,
		BENEFIT
FROM GS14
ORDER BY CALCULATED NAICS, YEAR; 

QUIT; 

DATA GS14_3; 
SET GS14_2; 
IF YEAR=2015 THEN DELETE; 
RUN; 

/*2013 DATA*/ 

/*IMPORTING IN GS13 FILE - HAS 2013 AND 2012 FIGURES*/ 
PROC IMPORT DATAFILE = 'H:\3.Teams and Projects\gradproject\GS13.XLSX'
OUT=GS13
DBMS=XLSX
REPLACE;
RUN;

/*PULLING ONLY THE VARIABLES WE NEED*/ 
PROC SQL NOPRINT; 

CREATE TABLE GS13_2 AS
SELECT	IFC(NAICS_ID EQ '31-33','31',NAICS_ID) AS NAICS LABEL="",
		NAICS_DISPLAY_LABEL AS NAICS_DESC LABEL="",
		GEO_DISPLAY_LABEL AS COUNTRY LABEL="",
		YEAR_ID AS YEAR LABEL="",
		RCPTOT, 
		CSTMTOT,
		PAYANN,
		EMP,
		/*STUFF YOU DON'T THINK YOU'LL NEED BUT ARE PULLING JUST IN CASE*/ 
		EMPAVPW,
		PAYANPW,
		BENEFIT
FROM GS13
ORDER BY CALCULATED NAICS, YEAR; 

QUIT; 

DATA GS13_3; 
SET GS13_2; 
IF YEAR=2014 THEN DELETE; 
RUN;


/*NOW THAT ALL FIVE YEARS HAVE BEEN PULLED, CREATING THE DATASET THAT HAS EVERYTHING TOGETHER*/ 
DATA GS5YEARS;
SET GS16_2;
RUN; 

PROC APPEND BASE=GS5YEARS DATA=GS14_3; 
RUN; 

PROC APPEND BASE=GS5YEARS DATA=GS13_3;
RUN; 


/*NOW MAKING THE TABLES FOR EACH OF THE FOUR CORE VARIABLES*/ 

/*RCPTOT*/ 
PROC SQL NOPRINT; 

CREATE TABLE US_RCPTOT AS
SELECT	NAICS,
		LENGTH(NAICS) AS LEVEL,
		NAICS_DESC,
		COUNTRY,
		YEAR,
		RCPTOT
FROM GS5YEARS
ORDER BY NAICS, YEAR; 

QUIT; 

PROC TRANSPOSE DATA=US_RCPTOT OUT=US_RCPTOT2;
BY NAICS; 
ID YEAR;
VAR RCPTOT;
RUN; 

PROC SQL NOPRINT; 

/*652 ROWS*/ 
CREATE TABLE US_RCPTOT3 AS
SELECT DISTINCT
		A.NAICS,
		B.LEVEL,
		B.NAICS_DESC,
		A._NAME_ AS VARIABLE LABEL="",
		"Total value of shipments and receipts for services ($1,000)" AS VAR_DESC,
		A._2012,
		A._2013,
		A._2014,
		A._2015,
		A._2016
FROM US_RCPTOT2 AS A
LEFT JOIN US_RCPTOT AS B
ON A.NAICS=B.NAICS
ORDER BY B.LEVEL, A.NAICS; 

/*CSTMTOT*/ 
PROC SQL NOPRINT; 

CREATE TABLE US_CSTMTOT AS
SELECT	NAICS,
		LENGTH(NAICS) AS LEVEL,
		NAICS_DESC,
		COUNTRY,
		YEAR,
		CSTMTOT
FROM GS5YEARS
ORDER BY NAICS, YEAR; 

QUIT; 

PROC TRANSPOSE DATA=US_CSTMTOT OUT=US_CSTMTOT2;
BY NAICS; 
ID YEAR;
VAR CSTMTOT;
RUN; 

PROC SQL NOPRINT; 

/*652 ROWS*/ 
CREATE TABLE US_CSTMTOT3 AS
SELECT DISTINCT
		A.NAICS,
		B.LEVEL,
		B.NAICS_DESC,
		A._NAME_ AS VARIABLE LABEL="",
		"Total cost of materials ($1,000)" AS VAR_DESC,
		A._2012,
		A._2013,
		A._2014,
		A._2015,
		A._2016
FROM US_CSTMTOT2 AS A
LEFT JOIN US_CSTMTOT AS B
ON A.NAICS=B.NAICS
ORDER BY B.LEVEL, A.NAICS; 

/*PAYANN*/ 
PROC SQL NOPRINT; 

CREATE TABLE US_PAYANN AS
SELECT	NAICS,
		LENGTH(NAICS) AS LEVEL,
		NAICS_DESC,
		COUNTRY,
		YEAR,
		PAYANN
FROM GS5YEARS
ORDER BY NAICS, YEAR; 

QUIT; 

PROC TRANSPOSE DATA=US_PAYANN OUT=US_PAYANN2;
BY NAICS; 
ID YEAR;
VAR PAYANN;
RUN; 

PROC SQL NOPRINT; 

/*652 ROWS*/ 
CREATE TABLE US_PAYANN3 AS
SELECT DISTINCT
		A.NAICS,
		B.LEVEL,
		B.NAICS_DESC,
		A._NAME_ AS VARIABLE LABEL="",
		"Annual payroll ($1,000)" AS VAR_DESC,
		A._2012,
		A._2013,
		A._2014,
		A._2015,
		A._2016
FROM US_PAYANN2 AS A
LEFT JOIN US_PAYANN AS B
ON A.NAICS=B.NAICS
ORDER BY B.LEVEL, A.NAICS; 

/*EMP*/ 
PROC SQL NOPRINT; 

CREATE TABLE US_EMP AS
SELECT	NAICS,
		LENGTH(NAICS) AS LEVEL,
		NAICS_DESC,
		COUNTRY,
		YEAR,
		EMP
FROM GS5YEARS
ORDER BY NAICS, YEAR; 

QUIT; 

PROC TRANSPOSE DATA=US_EMP OUT=US_EMP2;
BY NAICS; 
ID YEAR;
VAR EMP;
RUN; 

PROC SQL NOPRINT; 

/*652 ROWS*/ 
CREATE TABLE US_EMP3 AS
SELECT DISTINCT
		A.NAICS,
		B.LEVEL,
		B.NAICS_DESC,
		A._NAME_ AS VARIABLE LABEL="",
		"Number of employees" AS VAR_DESC,
		A._2012,
		A._2013,
		A._2014,
		A._2015,
		A._2016
FROM US_EMP2 AS A
LEFT JOIN US_EMP AS B
ON A.NAICS=B.NAICS
ORDER BY B.LEVEL, A.NAICS; 

/*DONE FOR US*/ 

/*2016 DATA FOR ALL VARS*/ 
/*652 ROWS*/ 
CREATE TABLE GS2016ONLY AS
SELECT	*
FROM GS5YEARS
WHERE YEAR=2016; 

/*DELETING DISCLOSURE ROWS*/ 
/*WENT FROM 652 TO 644*/ 
DATA GS2016ONLYNEW;
SET GS2016ONLY;
IF RCPTOT EQ 'D' THEN DELETE; 
IF CSTMTOT EQ 'D' THEN DELETE; 
IF PAYANN EQ 'D' THEN DELETE; 
IF EMP EQ 'i' THEN DELETE; 
RUN; 

